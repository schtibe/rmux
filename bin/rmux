#!/bin/bash

# Connect to remote host and take your tmux.conf and vimrc to the host
#
# Connect:
#    rmux $HOST
# Run tmux:
#    tmux ...
# Run vim:
#    vi ...
# Attach tmux session:
#    tmuc [id] ...
# Attach first session:
#    tmuk

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$SCRIPT_DIR/../rmuxid"

HOST="$1"
shift

if [[ ! "$HOST" == *@* ]]; then
	HOST="$USER@$HOST"
fi

if [ ! -S "$HOME/.ssh/cm/$HOST:22.conn" ]; then
	echo Connection setup
	ssh -X -A "$HOST" "uname -a; who"
	# uses existing connection
	rsync -r --delete --exclude=/tmux-bin --exclude=/.vim/spell --exclude=.git \
		--exclude=/bash_history --exclude=/my_history --exclude="*.pyc" "$HOME/.rmux-$RMUXID/" "$HOST":".rmux-$RMUXID/"
fi

ssh "$@" "$HOST" -t "bash --rcfile \"\$HOME/.rmux-$RMUXID/init\" -i"
